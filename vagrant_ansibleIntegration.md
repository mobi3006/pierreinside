# Vagrant-Ansible-Integration
Vagrant erlaubt das Provisioning von Maschinen über die Provider

* ``ansible``: das ist der typische Remote-Ansatz
* ``ansible_local``: hierbei erfolgt die Ausführung des Playbooks lokal auf dem Guest-System

---

# Windows-Host
Für eine komplette Automatisierung meiner [Workbench (VirtualBox-Linux-Image)](workbench.md) hatte ich die Idee, mittels Vagrant und Ansible ein komplett automatisiertes Setup zu scripten.

## Remote Ansible Provider ... funktioniert nicht
* http://docs.ansible.com/ansible/guide_vagrant.html

Der typische Ansible-Ansatz ermöglicht die Ausführung von Kommandos via ssh. Insofern paßt es perfekt in ein Vagrant-Host/Guest-Szenario - der Host sendet via ssh (wird von Vagrant eh schon konfiguriert) die entsprechenden Shell-Kommandos zum Guest. 

Einzige Voraussetzung ist die Installation von Ansible auf dem Host-System. Leider wird diese Einschränkung für Windows-Host-Systeme zum Ausschlußkriterium, denn Ansible wird für Windows nicht unterstützt. Für mein Workbench-Szenario kam diese Lösung demnach nicht in Frage.

## Local Ansible Provider
In diesem Fall muß Ansible auf dem Guest-System (= Linux-System) installiert werden. Das erfolgt 

* entweder automatisch durch die Option ``install`` (ACHTUNG: funktioniert nicht mit Vagrant 1.8.1, wohl aber mit 1.8.4 ... https://github.com/mitchellh/vagrant/issues/6858):


    config.vm.provision "ansible_local" do |ansible|
       ansible.playbook = "playbook.yml"
       install = true
    end

* oder per Shellscript-Provisioning im Vagrantfile - vorher muß natürlich das entsprechende Repository im Guest-System eingetragen sein (beim ``install_mode = default``) oder Ansible wird über den Python-Paketmanager installiert (beim ``install_mode = pip``):


    config.vm.provision "shell", inline: <<-SHELL
        sudo apt-get install -y ansible
    SHELL

Die ``ansible_local`` Variante hat den Charme, daß Ansible auf dem Host-System nicht installiert werden muß. Das hat folgende Vorteile:

* das Host-System wird nicht verändert
* solange nur der ``localhost`` als 
* das Ansible-Provisioning einer Vagrant-Maschine kann auch unter Windows KOMPLETT automatisiert (scriptbasiert) erfolgen
* auch **Windows-Host-Systeme** (für die es keinen offiziellen Ansible-Support gibt) **können Ansible-Provisioning verwenden** 

---

# Multi-Machine-Images
Bei der Verwendung von Ansible in Vagrant-Multi-Machine-Images baut Vagrant pro Maschine automatisch ein Inventory-File, das bei der Ausführung verwendet wird. 

Wird folgende Maschine gestartet (``vagrant up``)

    config.vm.define "INBOUND", primary: true do |inbound|
        ...
        inbound.vm.hostname ="inbound"
        ...
        inbound.vm.provider "virtualbox" do |v|
            v.customize [
                "modifyvm", :id,
                "--memory", 2000,
            ]
        end
        ...
        inbound.vm.provision "ansible_local" do |ansible|
            ansible.playbook = "playbook.yml"
            ansible.install  = true
            ansible.verbose  = true
        end        
    end

so wird das Playbook folgendermaßen aufgerufen: 

    INBOUND: Installing Ansible...
    INBOUND: Running ansible-playbook...
    cd /vagrant && 
      PYTHONUNBUFFERED=1 
      ANSIBLE_FORCE_COLOR=true 
      ansible-playbook 
      --limit="INBOUND" 
      --inventory-file=/tmp/vagrant-ansible/inventory 
      -v 
      playbook.yml
    Using /etc/ansible/ansible.cfg as config file

Im referenzierte ``inventory-file=/tmp/vagrant-ansible/inventory`` befindet sich eine von Vagrant erstellte Datei ``vagrant_ansible_local_inventory``:

    # Generated by Vagrant
    INBOUND ansible_connection=local

Dadurch wird bei der Ausführung des Playbooks gegen die Maschine *INBOUND* keine ssh-Infrastruktur benötigt. 

